import React, { useState, useEffect } from "react";
import { Copy, Eye, EyeOff, Printer, Mail } from "lucide-react";
import ConfirmationModal from "@/components/ConfirmationModal";

const EnhancedStudentRegistration = ({ schoolId, onSuccess }) => {
  const [currentPart, setCurrentPart] = useState(1); // 1: Student Details (simplified form)
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");
  const [success, setSuccess] = useState("");
  const [showPassword, setShowPassword] = useState(false);
  const [grades, setGrades] = useState([]);
  const [showConfirmation, setShowConfirmation] = useState(false);
  const [generatedCredentials, setGeneratedCredentials] = useState(null);

  // Credentials state (for internal use only, will be auto-generated)
  const [credentials, setCredentials] = useState({
    username: "",
    password: "",
  });

  // Student details state
  const [studentDetails, setStudentDetails] = useState({
    firstName: "",
    lastName: "",
    dateOfBirth: "",
    gender: "",
    phone: "",
    grade: "",
    rollNumber: "",
    address: "",
    bloodGroup: "",
  });

  // Parent details state - made optional
  const [parentDetails, setParentDetails] = useState({
    guardianRelationship: "FATHER",
    parentName: "",
    parentContactNumber: "",
    parentEmail: "",
    parentAlternativeContact: "",
  });

  // Fetch grades from school on mount
  useEffect(() => {
    const fetchGrades = async () => {
      try {
        const response = await fetch(
          `/api/schools/${schoolId}/config`
        );
        const data = await response.json();

        if (data.data?.grades) {
          setGrades(data.data.grades.split(",").map((g) => g.trim()));
        }
      } catch (err) {
        console.error("Failed to fetch grades:", err);
      }
    };

    if (schoolId) {
      fetchGrades();
    }
  }, [schoolId]);

  // Generate credentials
  const handleGenerateCredentials = async () => {
    if (!studentDetails.firstName || !studentDetails.lastName) {
      setError("Please enter first and last name first");
      return;
    }

    setLoading(true);
    setError("");

    try {
      const response = await fetch("/api/auth/generate-credentials", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          firstName: studentDetails.firstName,
          lastName: studentDetails.lastName,
          schoolId,
        }),
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.message || "Failed to generate credentials");
      }

      setCredentials({
        username: data.data.username,
        password: data.data.password,
      });

      setSuccess("Credentials generated successfully!");
    } catch (err) {
      setError(err.message);
    } finally {
      setLoading(false);
    }
  };

  // Copy to clipboard
  const handleCopyCredentials = () => {
    const text = `Username: ${credentials.username}\nPassword: ${credentials.password}`;
    navigator.clipboard.writeText(text);
    setSuccess("Credentials copied to clipboard!");
  };

  // Print credentials
  const handlePrintCredentials = () => {
    const printWindow = window.open("", "", "width=600,height=400");
    printWindow.document.write(`
      <html>
        <head>
          <title>Student Login Credentials</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 20px; }
            .container { border: 2px solid #333; padding: 20px; max-width: 500px; }
            h2 { text-align: center; }
            .field { margin: 15px 0; }
            label { font-weight: bold; display: block; margin-bottom: 5px; }
            .value { font-family: monospace; font-size: 14px; background: #f0f0f0; padding: 10px; border-radius: 4px; }
          </style>
        </head>
        <body>
          <div class="container">
            <h2>Student Login Credentials</h2>
            <div class="field">
              <label>Username:</label>
              <div class="value">${credentials.username}</div>
            </div>
            <div class="field">
              <label>Password:</label>
              <div class="value">${credentials.password}</div>
            </div>
            <p style="margin-top: 20px; font-size: 12px; color: #666;">
              Please keep these credentials safe and change the password on first login.
            </p>
          </div>
        </body>
      </html>
    `);
    printWindow.document.close();
    printWindow.print();
  };

  // Email credentials
  const handleEmailCredentials = async () => {
    setLoading(true);
    setError("");

    try {
      const response = await fetch("/api/students/send-credentials-email", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          parentEmail: parentDetails.parentEmail,
          parentName: parentDetails.parentName,
          studentName: `${studentDetails.firstName} ${studentDetails.lastName}`,
          username: credentials.username,
          password: credentials.password,
        }),
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.message || "Failed to send email");
      }

      setSuccess("Credentials emailed successfully!");
    } catch (err) {
      setError(err.message);
    } finally {
      setLoading(false);
    }
  };

  // Handle part 1 continue
  const handlePart1Continue = () => {
    if (!credentials.username || !credentials.password) {
      setError("Please generate credentials first");
      return;
    }
    setCurrentPart(2);
    setError("");
  };

  // Handle part 2 continue
  const handlePart2Continue = () => {
    if (
      !studentDetails.firstName ||
      !studentDetails.lastName ||
      !studentDetails.dateOfBirth ||
      !studentDetails.gender ||
      !studentDetails.grade ||
      !studentDetails.rollNumber
    ) {
      setError("Please fill in all required student fields (marked with *)");
      return;
    }
    setCurrentPart(2); // Move to optional parent details
    setError("");
  };

  // Handle final submission - auto-generate credentials here
  const handleSubmit = async () => {
    setShowConfirmation(true);
  };

  // Confirm and submit with auto-generated credentials
  const handleConfirmSubmit = async () => {
    setLoading(true);
    setError("");
    setShowConfirmation(false);

    try {
      // First, generate credentials
      const credResponse = await fetch("/api/auth/generate-credentials", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          firstName: studentDetails.firstName,
          lastName: studentDetails.lastName,
          schoolId,
        }),
      });

      const credData = await credResponse.json();

      if (!credResponse.ok) {
        throw new Error(credData.message || "Failed to generate credentials");
      }

      const generatedCreds = {
        username: credData.data.username,
        password: credData.data.password,
      };

      // Build registration payload - parent details are optional
      const registrationPayload = {
        ...studentDetails,
        username: generatedCreds.username,
        password: generatedCreds.password,
        school: schoolId,
        email: parentDetails.parentEmail || `${generatedCreds.username}@school.local`, // Fallback email if no parent email
      };

      // Add optional parent details if provided
      if (parentDetails.parentName) {
        registrationPayload.guardianRelationship = parentDetails.guardianRelationship;
        registrationPayload.parentName = parentDetails.parentName;
        registrationPayload.parentContactNumber = parentDetails.parentContactNumber;
        registrationPayload.parentEmail = parentDetails.parentEmail;
        registrationPayload.parentAlternativeContact = parentDetails.parentAlternativeContact;
      } else {
        // Provide defaults for optional parent fields
        registrationPayload.guardianRelationship = "FATHER";
        registrationPayload.parentName = "To be added";
        registrationPayload.parentContactNumber = "To be added";
        registrationPayload.parentEmail = "To be added";
        registrationPayload.parentAlternativeContact = "";
      }

      const response = await fetch("/api/students/register", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(registrationPayload),
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.message || "Registration failed");
      }

      // Store generated credentials for display
      setGeneratedCredentials(generatedCreds);
      setSuccess("Student registered successfully!");
      setCredentials(generatedCreds);
      // Reset form
      setTimeout(() => {
        setCurrentPart(1);
        setCredentials({ username: "", password: "" });
        setStudentDetails({
          firstName: "",
          lastName: "",
          dateOfBirth: "",
          gender: "",
          phone: "",
          grade: "",
          rollNumber: "",
          address: "",
          bloodGroup: "",
        });
        setParentDetails({
          guardianRelationship: "FATHER",
          parentName: "",
          parentContactNumber: "",
          parentEmail: "",
          parentAlternativeContact: "",
        });

        if (onSuccess) {
          onSuccess();
        }
      }, 2000);
    } catch (err) {
      setError(err.message);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="bg-white rounded-lg shadow-lg p-8 max-w-2xl mx-auto">
      <h2 className="text-3xl font-bold mb-8 text-center text-blue-600">
        Student Registration
      </h2>

      {/* Progress Indicator */}
      <div className="flex justify-between mb-8">
        {[1, 2].map((part) => (
          <div key={part} className="flex items-center">
            <div
              className={`w-10 h-10 rounded-full flex items-center justify-center font-bold ${
                currentPart >= part
                  ? "bg-blue-600 text-white"
                  : "bg-gray-300 text-gray-600"
              }`}
            >
              {part}
            </div>
            {part < 2 && (
              <div
                className={`w-16 h-1 ${
                  currentPart > part ? "bg-blue-600" : "bg-gray-300"
                }`}
              />
            )}
          </div>
        ))}
      </div>

      {/* Error and Success Messages */}
      {error && (
        <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg mb-4">
          {error}
        </div>
      )}
      {success && (
        <div className="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg mb-4">
          {success}
        </div>
      )}

      {/* Part 1: Student Information Entry */}
      {currentPart === 1 && (
        <div className="space-y-6">
          <h3 className="text-xl font-semibold text-gray-800 mb-4">
            Step 1: Student Information
          </h3>
          
          <p className="text-gray-600 bg-blue-50 border border-blue-200 rounded-lg p-4">
            üìù Please fill in the student's information below. Login credentials will be automatically generated during registration.
          </p>

          {/* First and Last Name */}
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                First Name *
              </label>
              <input
                type="text"
                placeholder="Enter first name"
                value={studentDetails.firstName}
                onChange={(e) =>
                  setStudentDetails({
                    ...studentDetails,
                    firstName: e.target.value,
                  })
                }
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Last Name *
              </label>
              <input
                type="text"
                placeholder="Enter last name"
                value={studentDetails.lastName}
                onChange={(e) =>
                  setStudentDetails({
                    ...studentDetails,
                    lastName: e.target.value,
                  })
                }
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
            </div>
          </div>

          {/* Date of Birth and Gender */}
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Date of Birth *
              </label>
              <input
                type="date"
                value={studentDetails.dateOfBirth}
                onChange={(e) =>
                  setStudentDetails({
                    ...studentDetails,
                    dateOfBirth: e.target.value,
                  })
                }
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Gender *
              </label>
              <select
                value={studentDetails.gender}
                onChange={(e) =>
                  setStudentDetails({
                    ...studentDetails,
                    gender: e.target.value,
                  })
                }
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              >
                <option value="">Select Gender</option>
                <option value="MALE">Male</option>
                <option value="FEMALE">Female</option>
                <option value="OTHER">Other</option>
              </select>
            </div>
          </div>

          {/* Grade and Roll Number */}
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Grade *
              </label>
              <select
                value={studentDetails.grade}
                onChange={(e) =>
                  setStudentDetails({
                    ...studentDetails,
                    grade: e.target.value,
                  })
                }
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              >
                <option value="">Select Grade</option>
                {grades.map((grade) => (
                  <option key={grade} value={grade}>
                    {grade}
                  </option>
                ))}
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Roll Number *
              </label>
              <input
                type="text"
                placeholder="Enter roll number"
                value={studentDetails.rollNumber}
                onChange={(e) =>
                  setStudentDetails({
                    ...studentDetails,
                    rollNumber: e.target.value,
                  })
                }
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
            </div>
          </div>

          {/* Phone Number */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              Phone Number
            </label>
            <input
              type="tel"
              placeholder="Enter phone number (optional)"
              value={studentDetails.phone}
              onChange={(e) =>
                setStudentDetails({
                  ...studentDetails,
                  phone: e.target.value,
                })
              }
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
          </div>

          {/* Address */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              Address
            </label>
            <textarea
              placeholder="Enter address (optional)"
              value={studentDetails.address}
              onChange={(e) =>
                setStudentDetails({
                  ...studentDetails,
                  address: e.target.value,
                })
              }
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              rows="3"
            />
          </div>

          {/* Blood Group */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              Blood Group
            </label>
            <select
              value={studentDetails.bloodGroup}
              onChange={(e) =>
                setStudentDetails({
                  ...studentDetails,
                  bloodGroup: e.target.value,
                })
              }
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              <option value="">Select Blood Group</option>
              <option value="O+">O+</option>
              <option value="O-">O-</option>
              <option value="A+">A+</option>
              <option value="A-">A-</option>
              <option value="B+">B+</option>
              <option value="B-">B-</option>
              <option value="AB+">AB+</option>
              <option value="AB-">AB-</option>
            </select>
          </div>

          <button
            onClick={handlePart2Continue}
            className="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition font-semibold"
          >
            Continue
          </button>
        </div>
      )}

      {/* Part 2: Optional Parent/Guardian Details & Confirmation */}
      {currentPart === 2 && (
        <div className="space-y-6">
          <h3 className="text-xl font-semibold text-gray-800 mb-4">
            Step 2: Optional Parent/Guardian Information
          </h3>

          <p className="text-gray-600 bg-blue-50 border border-blue-200 rounded-lg p-4">
            üë®‚Äçüë©‚Äçüëß You can add parent/guardian information now or fill it later. Leave blank to skip for now.
          </p>

          {/* Parent Details - All Optional */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              Relationship
            </label>
            <select
              value={parentDetails.guardianRelationship}
              onChange={(e) =>
                setParentDetails({
                  ...parentDetails,
                  guardianRelationship: e.target.value,
                })
              }
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              <option value="FATHER">Father</option>
              <option value="MOTHER">Mother</option>
              <option value="GUARDIAN">Guardian</option>
              <option value="UNCLE">Uncle</option>
              <option value="AUNT">Aunt</option>
              <option value="SIBLING">Sibling</option>
            </select>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              Parent/Guardian Full Name
            </label>
            <input
              type="text"
              placeholder="Enter parent/guardian name (optional)"
              value={parentDetails.parentName}
              onChange={(e) =>
                setParentDetails({
                  ...parentDetails,
                  parentName: e.target.value,
                })
              }
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Contact Number
              </label>
              <input
                type="tel"
                placeholder="Phone number (optional)"
                value={parentDetails.parentContactNumber}
                onChange={(e) =>
                  setParentDetails({
                    ...parentDetails,
                    parentContactNumber: e.target.value,
                  })
                }
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Email
              </label>
              <input
                type="email"
                placeholder="Email (optional)"
                value={parentDetails.parentEmail}
                onChange={(e) =>
                  setParentDetails({
                    ...parentDetails,
                    parentEmail: e.target.value,
                  })
                }
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
            </div>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              Alternative Contact
            </label>
            <input
              type="tel"
              placeholder="Alternative phone number (optional)"
              value={parentDetails.parentAlternativeContact}
              onChange={(e) =>
                setParentDetails({
                  ...parentDetails,
                  parentAlternativeContact: e.target.value,
                })
              }
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
          </div>

          {/* Summary of Student Information */}
          <div className="bg-gray-50 border border-gray-200 rounded-lg p-4 mt-6">
            <h4 className="font-semibold text-gray-800 mb-3">Student Information Summary</h4>
            <div className="grid grid-cols-2 gap-2 text-sm">
              <div><span className="font-medium">Name:</span> {studentDetails.firstName} {studentDetails.lastName}</div>
              <div><span className="font-medium">Grade:</span> {studentDetails.grade}</div>
              <div><span className="font-medium">Date of Birth:</span> {studentDetails.dateOfBirth}</div>
              <div><span className="font-medium">Roll Number:</span> {studentDetails.rollNumber}</div>
              <div><span className="font-medium">Gender:</span> {studentDetails.gender}</div>
              <div><span className="font-medium">Phone:</span> {studentDetails.phone || "Not provided"}</div>
            </div>
          </div>

          <div className="flex gap-4">
            <button
              onClick={() => {
                setCurrentPart(1);
                setError("");
              }}
              className="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-400 transition font-semibold"
            >
              Back
            </button>
            <button
              onClick={handleSubmit}
              className="flex-1 bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition font-semibold"
            >
              Register Student
            </button>
          </div>
        </div>
      )}

      {/* Confirmation Modal */}
      <ConfirmationModal
        isOpen={showConfirmation}
        title="Confirm Student Registration"
        message={`Please confirm the registration for ${studentDetails.firstName} ${studentDetails.lastName}. Login credentials will be auto-generated and can be retrieved after registration.`}
        onConfirm={handleConfirmSubmit}
        onCancel={() => setShowConfirmation(false)}
      />

      {/* Success - Show Generated Credentials */}
      {credentials.username && credentials.password && success && (
        <div className="bg-green-50 border border-green-200 rounded-lg p-6 mt-6">
          <h4 className="font-semibold text-lg text-green-800 mb-4">‚úÖ Student Registered Successfully!</h4>
          
          <div className="bg-white border border-green-300 rounded-lg p-4 mb-4">
            <p className="text-sm text-gray-700 mb-3"><span className="font-semibold">Student Name:</span> {studentDetails.firstName} {studentDetails.lastName}</p>
            <p className="text-sm text-gray-700 mb-3"><span className="font-semibold">Grade:</span> {studentDetails.grade}</p>
            <p className="text-sm text-gray-700 mb-3"><span className="font-semibold">Roll Number:</span> {studentDetails.rollNumber}</p>
          </div>

          <h5 className="font-semibold text-gray-800 mb-2">Auto-Generated Login Credentials:</h5>
          <div className="space-y-3">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Username</label>
              <div className="flex items-center gap-2">
                <input
                  type="text"
                  value={credentials.username}
                  readOnly
                  className="flex-1 px-4 py-2 border border-gray-300 rounded-lg bg-white font-mono text-sm"
                />
                <button
                  onClick={handleCopyCredentials}
                  className="p-2 text-green-600 hover:bg-green-100 rounded-lg transition"
                  title="Copy"
                >
                  <Copy size={20} />
                </button>
              </div>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Password</label>
              <div className="flex items-center gap-2">
                <input
                  type={showPassword ? "text" : "password"}
                  value={credentials.password}
                  readOnly
                  className="flex-1 px-4 py-2 border border-gray-300 rounded-lg bg-white font-mono text-sm"
                />
                <button
                  onClick={() => setShowPassword(!showPassword)}
                  className="p-2 text-green-600 hover:bg-green-100 rounded-lg transition"
                  title="Show/Hide"
                >
                  {showPassword ? <EyeOff size={20} /> : <Eye size={20} />}
                </button>
              </div>
            </div>
          </div>

          <div className="grid grid-cols-3 gap-2 mt-4">
            <button
              onClick={handleCopyCredentials}
              className="flex items-center justify-center gap-2 px-3 py-2 bg-white border border-green-300 text-green-600 rounded-lg hover:bg-green-50 transition text-sm"
            >
              <Copy size={16} /> Copy
            </button>
            <button
              onClick={handlePrintCredentials}
              className="flex items-center justify-center gap-2 px-3 py-2 bg-white border border-green-300 text-green-600 rounded-lg hover:bg-green-50 transition text-sm"
            >
              <Printer size={16} /> Print
            </button>
            <button
              onClick={handleEmailCredentials}
              disabled={!parentDetails.parentEmail}
              className="flex items-center justify-center gap-2 px-3 py-2 bg-white border border-green-300 text-green-600 rounded-lg hover:bg-green-50 transition text-sm disabled:opacity-50 disabled:cursor-not-allowed"
              title={parentDetails.parentEmail ? "Send credentials to parent email" : "Parent email not provided"}
            >
              <Mail size={16} /> Email
            </button>
          </div>

          <p className="text-xs text-gray-600 mt-3">
            ‚ÑπÔ∏è Keep these credentials safe. The student can change the password after first login.
          </p>

          <button
            onClick={() => {
              setCredentials({ username: "", password: "" });
              setStudentDetails({
                firstName: "",
                lastName: "",
                dateOfBirth: "",
                gender: "",
                phone: "",
                grade: "",
                rollNumber: "",
                address: "",
                bloodGroup: "",
              });
              setParentDetails({
                guardianRelationship: "FATHER",
                parentName: "",
                parentContactNumber: "",
                parentEmail: "",
                parentAlternativeContact: "",
              });
              setCurrentPart(1);
              setSuccess("");
            }}
            className="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition font-semibold mt-4"
          >
            Register Another Student
          </button>
        </div>
      )}
    </div>
  );
};

export default EnhancedStudentRegistration;
